<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAZDAR!</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'Open Sans', sans-serif;
  background: linear-gradient(160deg,#888,#ccc);
  color: #ffd700;
  overflow-x: hidden;
}
body::before, body::after {
  content: "✈";
  position: fixed;
  color: rgba(255,215,0,0.25);
  font-size: 250px;
  pointer-events: none;
  animation: floatPlane 30s infinite linear;
}
body::before { top: 10%; left: -200px; transform: rotate(-15deg); }
body::after { top: 60%; left: 70%; transform: rotate(15deg); animation-direction: reverse; }
@keyframes floatPlane {
  0%{transform:translateX(0) rotate(-15deg);opacity:0.25;}
  50%{opacity:0.1;}
  100%{transform:translateX(110vw) rotate(-15deg);opacity:0.25;}
}

.container {
  max-width: 540px;
  margin: 20px auto;
  background: linear-gradient(145deg,#555,#777);
  border-radius: 18px;
  padding: 30px 40px 40px 40px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
}
#mainTitle {
  text-align:center;
  font-family:'Montserrat',sans-serif;
  font-size:34px;
  text-shadow:0 0 6px #ffd700,0 0 18px #ffd700;
}
#dateTime, #nameday {
  text-align:center;
  font-size:18px;
  margin-bottom:10px;
  color:#ffd700;
}

.item {
  background:#777;
  margin-top:12px;
  padding:18px 20px;
  border-radius:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:18px;
  font-weight:700;
  color:#ffd700;
  cursor:pointer;
  transition:0.2s ease;
}
.item:hover { background:#888; }
.selected {
  background:#ffd700;
  color:#000 !important;
  box-shadow:0 4px 12px rgba(255,215,0,0.6);
}
.remove-btn {
  background:#ff5555;
  color:white;
  width:34px;
  height:34px;
  border-radius:50%;
  text-align:center;
  font-size:18px;
  margin-left:10px;
}

.action-btn {
  width:100%;
  padding:16px;
  margin-top:12px;
  font-size:18px;
  font-weight:800;
  background:#4CAF50;
  color:#fff;
  border-radius:14px;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(76,175,80,0.5);
}
.action-btn:hover { background:#45a049; transform:scale(1.03); }

#confirmation {
  text-align:center;
  margin-top:10px;
  font-size:16px;
  color:#00ff00;
  font-weight:bold;
  display:none;
}

#dateSelection {
  display:flex;
  gap:10px;
  justify-content:center;
  margin-bottom:15px;
  flex-wrap:wrap;
}
.date-btn {
  width:120px;
  padding:10px;
  font-size:14px;
  text-align:center;
  border-radius:12px;
  background:#666;
  color:#ffd700;
  font-weight:700;
  cursor:pointer;
}
.date-btn.selected {
  background:#ffd700;
  color:#000;
  box-shadow:0 4px 10px rgba(255,215,0,0.7);
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th, td {
  border:1px solid #ffd700;
  padding:6px;
  font-size:14px;
  text-align:center;
  font-weight:700;
}
th { background:#555; }

textarea, input {
  width:100%;
  padding:10px;
  border-radius:10px;
  margin-top:5px;
  font-size:16px;
}
</style>
</head>
<body>

<div class="container">

<h2 id="mainTitle">NAZDAR!</h2>
<div id="dateTime"></div>
<div id="nameday">Svátek: …</div>

<h2>Employees</h2>
<div id="employees"></div>
<input id="newEmployee" placeholder="Add employee name…" autocomplete="off">
<button class="action-btn" onclick="addEmployee()">Add Employee</button>

<h2>Aircraft</h2>
<div id="aircrafts"></div>
<input id="newAircraft" placeholder="Add aircraft registration…" autocomplete="off">
<button class="action-btn" onclick="addAircraft()">Add Aircraft</button>

<h2>Date of Log</h2>
<div id="dateSelection">
  <div class="date-btn" id="dbYesterdayBtn" onclick="selectLogDate('dayBeforeYesterday')">Day Before Yesterday</div>
  <div class="date-btn" id="yesterdayBtn" onclick="selectLogDate('yesterday')">Yesterday</div>
  <div class="date-btn selected" id="todayBtn" onclick="selectLogDate('today')">Today</div>
</div>

<h2>Hours Worked</h2>
<input type="number" id="hours" value="1" step="0.5" min="0">
<div style="display:flex; justify-content:center; gap:10px; margin-top:8px;">
  <div class="date-btn" onclick="setHours(2)">2h</div>
  <div class="date-btn" onclick="setHours(4)">4h</div>
  <div class="date-btn" onclick="setHours(6)">6h</div>
  <div class="date-btn" onclick="setHours(8)">8h</div>
</div>

<h2>Comment</h2>
<textarea id="comment" placeholder="Add comments (optional)…"></textarea>
<button class="action-btn" onclick="saveLog()">Save</button>
<div id="confirmation">Log saved!</div>

<h2>Recent Logs (Summed Hours)</h2>
<div id="historyTableContainer"></div>

<div class="action-btn" onclick="exportCSV()">Export CSV</div>

</div>

<script>
// ---------- FIREBASE ----------
const firebaseConfig = {
  apiKey: "AIzaSyDy9FB7VOZigjURYvtPVk3iBCj0kzFAk8E",
  authDomain: "labourlogger.firebaseapp.com",
  projectId: "labourlogger",
  storageBucket: "labourlogger.firebasestorage.app",
  messagingSenderId: "904527973038",
  appId: "1:904527973038:web:9be4fe8c71052b447c7b3f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------- LOCAL STORAGE (MINIMALLY CHANGED) ----------
let employees = [];
let aircraftList = [];
let logs = [];
let selectedEmployee="", selectedAircraft=[], selectedLogDate="today";

// ---------- EMPLOYEES SYNC ----------
db.collection("employees").orderBy("name").onSnapshot(snap=>{
  employees=[];
  snap.forEach(doc=>employees.push(doc.data().name));
  renderEmployees();
});

// ---------- AIRCRAFT SYNC ----------
db.collection("aircraft").orderBy("name").onSnapshot(snap=>{
  aircraftList=[];
  snap.forEach(doc=>aircraftList.push(doc.data().name));
  renderAircrafts();
});

// ---------- LOGS SYNC ----------
db.collection("logs").orderBy("date","desc").onSnapshot(snap=>{
  logs=[];
  snap.forEach(doc=>logs.push(doc.data()));
  updateHistoryTable();
});

// ---------- NAMEDAY ----------
async function fetchNameday(){
  try{
    const res = await fetch("https://www.seznam.cz/");
    const txt = await res.text();
    const match = txt.match(/Svátek dnes: <strong>(.*?)<\/strong>/);
    document.getElementById("nameday").textContent =
      match ? "Svátek: "+match[1] : "Svátek: —";
  }catch(e){
    document.getElementById("nameday").textContent = "Svátek: —";
  }
}
setInterval(updateDateTime,1000);
updateDateTime();
fetchNameday();

function updateDateTime(){
  const now = new Date();
  const dStr = now.toLocaleDateString("cs-CZ",{day:"2-digit",month:"2-digit",year:"numeric"});
  const tStr = now.toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  document.getElementById("dateTime").textContent = `${dStr} – ${tStr}`;
}

// ---------- RENDER (UNCHANGED) ----------
function renderEmployees(){
  const div=document.getElementById("employees");
  div.innerHTML="";
  employees.forEach(e=>{
    const item=document.createElement("div");
    item.className="item"+(e===selectedEmployee?" selected":"");
    item.innerHTML=`<span>${e} ✈</span>`;
    item.onclick=()=>{selectedEmployee=e;renderEmployees();};
    div.appendChild(item);
  });
}
function renderAircrafts(){
  const div=document.getElementById("aircrafts");
  div.innerHTML="";
  aircraftList.forEach(a=>{
    const item=document.createElement("div");
    item.className="item"+(selectedAircraft.includes(a)?" selected":"");
    item.innerHTML=`<span>${a} ✈</span>`;
    item.onclick=()=>{toggleAircraft(a);renderAircrafts();};
    div.appendChild(item);
  });
}
function toggleAircraft(a){
  selectedAircraft.includes(a)
    ? selectedAircraft=selectedAircraft.filter(x=>x!==a)
    : selectedAircraft.push(a);
}

// ---------- ADD (MINIMALLY CHANGED) ----------
function addEmployee(){
  const val=document.getElementById("newEmployee").value.trim();
  if(val) db.collection("employees").add({name:val});
  document.getElementById("newEmployee").value="";
}
function addAircraft(){
  const val=document.getElementById("newAircraft").value.trim();
  if(val) db.collection("aircraft").add({name:val});
  document.getElementById("newAircraft").value="";
}

// ---------- LOG DATE ----------
function selectLogDate(str){
  selectedLogDate=str;
  document.querySelectorAll(".date-btn").forEach(b=>b.classList.remove("selected"));
  if(str==="dayBeforeYesterday")dbYesterdayBtn.classList.add("selected");
  if(str==="yesterday")yesterdayBtn.classList.add("selected");
  if(str==="today")todayBtn.classList.add("selected");
}

// ---------- HOURS ----------
function setHours(h){document.getElementById("hours").value=h;}

// ---------- SAVE LOG ----------
function saveLog(){
  if(!selectedEmployee||!selectedAircraft.length){
    alert("Select employee and aircraft.");
    return;
  }
  const hours=parseFloat(document.getElementById("hours").value)||0;
  const comment=document.getElementById("comment").value.trim();
  const now=new Date();
  let logDate=new Date();
  if(selectedLogDate==="dayBeforeYesterday")logDate.setDate(now.getDate()-2);
  if(selectedLogDate==="yesterday")logDate.setDate(now.getDate()-1);

  selectedAircraft.forEach(ac=>{
    db.collection("logs").add({
      employee:selectedEmployee,
      aircraft:ac,
      hours,
      comment,
      date:logDate.toISOString()
    });
  });

  selectedEmployee="";
  selectedAircraft=[];
  document.getElementById("hours").value=1;
  document.getElementById("comment").value="";
  renderEmployees();
  renderAircrafts();

  const conf=document.getElementById("confirmation");
  conf.style.display="block";
  setTimeout(()=>conf.style.display="none",2000);
}

// ---------- HISTORY ----------
function updateHistoryTable(){
  let sums={};
  logs.forEach(l=>{
    const key=`${l.aircraft} | ${l.employee}`;
    sums[key]=(sums[key]||0)+l.hours;
  });
  let html='<table><tr><th>Aircraft</th><th>Employee</th><th>Total Hours</th></tr>';
  for(let k in sums){
    const p=k.split(" | ");
    html+=`<tr><td>${p[0]}</td><td>${p[1]}</td><td>${sums[k]}</td></tr>`;
  }
  html+='</table>';
  document.getElementById("historyTableContainer").innerHTML=html;
}

// ---------- CSV EXPORT ----------
function exportCSV(){
  let csv="Aircraft,Employee,Hours,Comment,Date\n";
  logs.forEach(l=>{
    csv+=`${l.aircraft},${l.employee},${l.hours},"${l.comment}",${new Date(l.date).toLocaleString("cs-CZ")}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="labour_log.csv";
  a.click();
}
</script>
</body>
</html>
